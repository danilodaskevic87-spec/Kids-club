<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Kids Club ‚Ä¢ –õ—ñ—Å</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(#c8f3c2, #f4fff1);
  padding: 20px;
}

.container {
  max-width: 900px;
  margin: auto;
}

/* ===== AUTH ===== */
.auth-box {
  max-width: 360px;
  margin: 80px auto;
  background: white;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
}

.auth-box h2 {
  text-align: center;
}

.auth-box input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.auth-box button {
  width: 100%;
  padding: 10px;
  background: #43a047;
  border: none;
  border-radius: 12px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

.switch {
  text-align: center;
  margin-top: 10px;
  cursor: pointer;
  color: #2e7d32;
}

/* ===== PROFILE ===== */
.profile {
  background: white;
  border-radius: 20px;
  padding: 20px;
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 30px;
}

.profile-avatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #4caf50;
}

.balance {
  font-size: 22px;
  font-weight: bold;
  color: #2e7d32;
}

.history-box {
  margin-top: 10px;
  max-height: 140px;
  overflow-y: auto;
  background: #f1f8e9;
  padding: 10px;
  border-radius: 12px;
  font-size: 14px;
}

/* ===== SHOP ===== */
.shop {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
}

.item {
  background: white;
  border-radius: 18px;
  padding: 15px;
  text-align: center;
}

.shop-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 12px;
}

button.buy {
  margin-top: 10px;
  padding: 10px;
  width: 100%;
  background: #43a047;
  border: none;
  border-radius: 12px;
  color: white;
  font-size: 16px;
}

.logout {
  margin-top: 10px;
  background: #c62828;
}
</style>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth" class="auth-box">
  <h2 id="authTitle">–í—Ö—ñ–¥</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
  <div class="switch" onclick="toggleAuth()">–ù–µ–º–∞ –∞–∫–∞—É–Ω—Ç—É? –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
</div>

<!-- APP -->
<div id="app" style="display:none;">

  <button class="logout" onclick="logout()">–í–∏–π—Ç–∏</button>

  <div class="profile">
    <img id="avatar" class="profile-avatar">
    <div>
      <h2 id="name"></h2>
      <div id="age"></div>
      <div class="balance">üå≤ –¢–æ–∫–µ–Ω–∏: <span id="tokens">0</span></div>
      <div class="history-box" id="history"></div>
    </div>
  </div>

  <h2>üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
  <div class="shop" id="shop"></div>

</div>
</div>

<script>
const supabase = supabase.createClient(
  "https://ljwbrffqkttuvqnzeyur.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxqd2JyZmZxa3R0dXZxbnpleXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTcxMDgsImV4cCI6MjA4NDMzMzEwOH0.81mAhg6ai_MJHr7WZe5cnp5CLEVWmfDiXxu_HxxSOJU"
);

let isRegister = false;
let userId = null;

function toggleAuth() {
  isRegister = !isRegister;
  document.getElementById("authTitle").textContent =
    isRegister ? "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è" : "–í—Ö—ñ–¥";
  document.querySelector(".auth-box button").textContent =
    isRegister ? "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" : "–£–≤—ñ–π—Ç–∏";
}

async function login() {
  const email = email.value;
  const password = password.value;

  let res;
  if (isRegister) {
    res = await supabase.auth.signUp({ email, password });
  } else {
    res = await supabase.auth.signInWithPassword({ email, password });
  }

  if (res.error) {
    alert(res.error.message);
    return;
  }

  initUser();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

async function initUser() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) return;

  userId = data.user.id;

  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";

  await supabase.from("profiles").upsert({
    id: userId,
    name: "–î–∏—Ç–∏–Ω–∞",
    age: 7,
    tokens: 0
  });

  loadProfile();
  loadHistory();
  loadShop();
}

async function loadProfile() {
  const { data } = await supabase.from("profiles").select("*").eq("id", userId).single();
  avatar.src = data.image_link || "https://via.placeholder.com/150";
  name.textContent = data.name;
  age.textContent = data.age ? `–í—ñ–∫: ${data.age}` : "";
  tokens.textContent = data.tokens;
}

async function loadHistory() {
  const { data } = await supabase
    .from("token_history")
    .select("*")
    .eq("user_id", userId)
    .order("created_at", { ascending: false });

  history.innerHTML = "";
  data.forEach(r => {
    const d = document.createElement("div");
    d.textContent = `${r.change > 0 ? "+" : ""}${r.change} ‚Äî ${r.reason}`;
    history.appendChild(d);
  });
}

async function loadShop() {
  const { data } = await supabase.from("shop_items").select("*").eq("is_active", true);
  shop.innerHTML = "";
  data.forEach(item => {
    shop.innerHTML += `
      <div class="item">
        <img src="${item.image_link}" class="shop-image">
        <h3>${item.title}</h3>
        <p>${item.price} —Ç–æ–∫–µ–Ω—ñ–≤</p>
        <button class="buy" onclick="buyItem('${item.id}')">–ö—É–ø–∏—Ç–∏</button>
      </div>
    `;
  });
}

async function buyItem(itemId) {
  const { error } = await supabase.rpc("buy_item", { p_item_id: itemId });
  if (error) alert(error.message);
}

supabase
  .channel("realtime")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "token_history" },
    () => {
      loadProfile();
      loadHistory();
    }
  )
  .subscribe();

initUser();
</script>
</body>
</html>
