<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Kids Club</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;background:#e8f5e9;padding:20px}
.box{background:#fff;padding:20px;border-radius:12px;max-width:600px;margin:auto}
.hidden{display:none}
.shop{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.item{border:1px solid #ccc;padding:10px;border-radius:10px}
</style>
</head>

<body>

<div class="box" id="auth">
  <h2>–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
  <button id="regBtn">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
</div>

<div class="box hidden" id="app">
  <h2 id="name"></h2>
  <div id="age"></div>
  <b>–¢–æ–∫–µ–Ω–∏:</b> <span id="tokens"></span>

  <h3>üìú –Ü—Å—Ç–æ—Ä—ñ—è</h3>
  <div id="history"></div>

  <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
  <div class="shop" id="shop"></div>

  <br>
  <button id="logoutBtn">–í–∏–π—Ç–∏</button>
</div>

<script>
const sb = supabase.createClient(
  "https://ljwbrffqkttuvqnzeyur.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxqd2JyZmZxa3R0dXZxbnpleXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTcxMDgsImV4cCI6MjA4NDMzMzEwOH0.81mAhg6ai_MJHr7WZe5cnp5CLEVWmfDiXxu_HxxSOJU"
);

const authBox = auth;
const appBox = app;

async function ensureProfile(uid){
  const { data } = await sb.from("profiles").select("*").eq("id",uid).single();
  if(!data){
    await sb.from("profiles").insert({id:uid});
  }
}

async function loadProfile(uid){
  const { data } = await sb.from("profiles").select("*").eq("id",uid).single();
  name.innerText = data.name;
  age.innerText = "–í—ñ–∫: " + data.age;
  tokens.innerText = data.tokens;
}

async function loadHistory(uid){
  const { data } = await sb
    .from("token_history")
    .select("*")
    .eq("user_id",uid)
    .order("created_at",{ascending:false});

  history.innerHTML="";
  data.forEach(r=>{
    history.innerHTML += `<div>${r.change>0?"+":""}${r.change} ‚Äî ${r.reason}</div>`;
  });
}

async function loadShop(){
  const { data } = await sb.from("shop_items").select("*").eq("is_active",true);
  shop.innerHTML="";
  data.forEach(i=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`${i.title}<br>${i.price} —Ç–æ–∫–µ–Ω—ñ–≤<br>
      <button>–ö—É–ø–∏—Ç–∏</button>`;
    d.querySelector("button").onclick=()=>buy(i.id);
    shop.appendChild(d);
  });
}

async function buy(id){
  const r = await sb.rpc("buy_item",{p_item_id:id});
  if(r.error) alert(r.error.message);
  start();
}

async function start(){
  const { data } = await sb.auth.getUser();
  if(!data.user) return;
  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  await ensureProfile(data.user.id);
  await loadProfile(data.user.id);
  await loadHistory(data.user.id);
  await loadShop();
}

loginBtn.onclick = async()=>{
  await sb.auth.signInWithPassword({email:email.value,password:password.value});
  start();
};
regBtn.onclick = async()=>{
  await sb.auth.signUp({email:email.value,password:password.value});
  start();
};
logoutBtn.onclick = async()=>{
  await sb.auth.signOut();
  location.reload();
};

start();
</script>
</body>
</html>
