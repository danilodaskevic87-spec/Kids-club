<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Kids Club üå≤</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(#c8f3c2, #f4fff1);
  padding: 20px;
}

h2,h3 { margin: 6px 0; }

.container {
  max-width: 1000px;
  margin: auto;
}

/* ===== AUTH ===== */
.auth-box {
  max-width: 360px;
  margin: 80px auto;
  background: white;
  padding: 22px;
  border-radius: 18px;
  box-shadow: 0 10px 25px rgba(0,0,0,.15);
}

.auth-box input {
  width: 100%;
  padding: 12px;
  margin: 6px 0;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.auth-box button {
  width: 100%;
  padding: 12px;
  background: #43a047;
  border: none;
  border-radius: 12px;
  color: white;
  font-size: 16px;
}

.switch {
  text-align: center;
  margin-top: 10px;
  cursor: pointer;
  color: #2e7d32;
}

/* ===== PROFILE ===== */
.profile {
  background: white;
  border-radius: 22px;
  padding: 20px;
  display: flex;
  gap: 20px;
  align-items: center;
  box-shadow: 0 8px 20px rgba(0,0,0,.1);
  margin-bottom: 30px;
}

.avatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #4caf50;
}

.balance {
  font-size: 22px;
  font-weight: bold;
  color: #2e7d32;
}

.history {
  margin-top: 10px;
  background: #f1f8e9;
  padding: 10px;
  border-radius: 12px;
  max-height: 140px;
  overflow-y: auto;
  font-size: 14px;
}

/* ===== SHOP ===== */
.shop {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap: 20px;
}

.item {
  background: white;
  border-radius: 18px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 6px 14px rgba(0,0,0,.1);
}

.shop-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 12px;
}

.buy {
  margin-top: 8px;
  padding: 10px;
  width: 100%;
  background: #43a047;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 15px;
}

.logout {
  margin-bottom: 15px;
  background: #c62828;
}
</style>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth" class="auth-box">
  <h2 id="authTitle">–í—Ö—ñ–¥</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)">
  <button onclick="submitAuth()">–£–≤—ñ–π—Ç–∏</button>
  <div class="switch" onclick="toggleAuth()">–ù–µ–º–∞ –∞–∫–∞—É–Ω—Ç—É? –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
</div>

<!-- APP -->
<div id="app" style="display:none;">

  <button class="logout" onclick="logout()">–í–∏–π—Ç–∏</button>

  <!-- PROFILE -->
  <div class="profile">
    <img id="avatar" class="avatar">
    <div>
      <h2 id="name"></h2>
      <div id="age"></div>
      <div class="balance">üå≤ –¢–æ–∫–µ–Ω–∏: <span id="tokens">0</span></div>
      <div class="history" id="history"></div>
    </div>
  </div>

  <!-- SHOP -->
  <h2>üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
  <div class="shop" id="shop"></div>

</div>
</div>

<script>
const sb = supabase.createClient(
  "https://ljwbrffqkttuvqnzeyur.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxqd2JyZmZxa3R0dXZxbnpleXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTcxMDgsImV4cCI6MjA4NDMzMzEwOH0.81mAhg6ai_MJHr7WZe5cnp5CLEVWmfDiXxu_HxxSOJU"
);

let isRegister = false;
let userId = null;

function toggleAuth(){
  isRegister = !isRegister;
  authTitle.innerText = isRegister ? "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è" : "–í—Ö—ñ–¥";
}

async function submitAuth(){
  const e = email.value;
  const p = password.value;
  if (p.length < 6) return alert("–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤");

  const r = isRegister
    ? await sb.auth.signUp({ email:e, password:p })
    : await sb.auth.signInWithPassword({ email:e, password:p });

  if (r.error) return alert(r.error.message);
  initApp();
}

async function logout(){
  await sb.auth.signOut();
  location.reload();
}

async function initApp(){
  const { data } = await sb.auth.getUser();
  if (!data.user) return;

  userId = data.user.id;
  auth.style.display = "none";
  app.style.display = "block";

  await sb.from("profiles").upsert({
    id: userId,
    name: "–î–∏—Ç–∏–Ω–∞",
    age: 7,
    tokens: 0
  });

  loadProfile();
  loadHistory();
  loadShop();
}

async function loadProfile(){
  const { data } = await sb.from("profiles").select("*").eq("id", userId).single();
  avatar.src = data.image_link || "https://via.placeholder.com/150";
  name.innerText = data.name;
  age.innerText = data.age ? `–í—ñ–∫: ${data.age}` : "";
  tokens.innerText = data.tokens;
}

async function loadHistory(){
  const { data } = await sb.from("token_history")
    .select("*").eq("user_id", userId)
    .order("created_at", { ascending:false });

  history.innerHTML = "";
  data.forEach(r=>{
    const d = document.createElement("div");
    d.textContent = `${r.change>0?"+":""}${r.change} ‚Äî ${r.reason}`;
    history.appendChild(d);
  });
}

async function loadShop(){
  const { data } = await sb.from("shop_items").select("*").eq("is_active", true);
  shop.innerHTML = "";
  data.forEach(i=>{
    shop.innerHTML += `
      <div class="item">
        <img src="${i.image_link}" class="shop-image">
        <h3>${i.title}</h3>
        <p>${i.price} —Ç–æ–∫–µ–Ω—ñ–≤</p>
        <button class="buy" onclick="buyItem('${i.id}')">–ö—É–ø–∏—Ç–∏</button>
      </div>`;
  });
}

async function buyItem(id){
  const { error } = await sb.rpc("buy_item", { p_item_id:id });
  if (error) alert(error.message);
}

sb.channel("rt")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"token_history"},
    ()=>{ loadProfile(); loadHistory(); })
  .subscribe();

initApp();
</script>
</body>
</html>
