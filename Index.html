<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Kids Club • Ліс</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(#c8f3c2, #f4fff1);
  padding: 20px;
}
.container {
  max-width: 900px;
  margin: auto;
}

/* AUTH */
.auth-box {
  max-width: 360px;
  margin: 80px auto;
  background: white;
  padding: 20px;
  border-radius: 16px;
}
.auth-box input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
}
.auth-box button {
  width: 100%;
  padding: 10px;
  background: #43a047;
  border: none;
  color: white;
  border-radius: 10px;
}
.switch {
  text-align: center;
  margin-top: 10px;
  cursor: pointer;
}

/* APP */
.profile {
  background: white;
  border-radius: 20px;
  padding: 20px;
  display: flex;
  gap: 20px;
}
.profile-avatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
}
.balance {
  font-size: 20px;
}
.shop {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap: 20px;
}
.item {
  background: white;
  padding: 15px;
  border-radius: 14px;
}
.shop-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
}
</style>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth" class="auth-box">
  <h2 id="authTitle">Вхід</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Пароль">
  <button onclick="submitAuth()">Увійти</button>
  <div class="switch" onclick="toggleAuth()">Нема акаунту? Реєстрація</div>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <button onclick="logout()">Вийти</button>

  <div class="profile">
    <img id="avatar" class="profile-avatar">
    <div>
      <h2 id="name"></h2>
      <div id="age"></div>
      <div class="balance">Токени: <span id="tokens">0</span></div>
      <div id="history"></div>
    </div>
  </div>

  <h2>Магазин</h2>
  <div class="shop" id="shop"></div>
</div>

</div>

<script>
const supabase = supabase.createClient(
  "https://ljwbrffqkttuvqnzeyur.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxqd2JyZmZxa3R0dXZxbnpleXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTcxMDgsImV4cCI6MjA4NDMzMzEwOH0.81mAhg6ai_MJHr7WZe5cnp5CLEVWmfDiXxu_HxxSOJU"
);

let isRegister = false;
let userId = null;

function toggleAuth() {
  isRegister = !isRegister;
  document.getElementById("authTitle").innerText =
    isRegister ? "Реєстрація" : "Вхід";
}

async function submitAuth() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  let res;
  if (isRegister) {
    res = await supabase.auth.signUp({ email, password });
  } else {
    res = await supabase.auth.signInWithPassword({ email, password });
  }

  if (res.error) {
    alert(res.error.message);
    return;
  }

  initUser();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

async function initUser() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) return;

  userId = data.user.id;

  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";

  await supabase.from("profiles").upsert({
    id: userId,
    name: "Дитина",
    age: 7,
    tokens: 0
  });

  loadProfile();
  loadShop();
}

async function loadProfile() {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  avatar.src = data.image_link || "https://via.placeholder.com/150";
  name.innerText = data.name;
  age.innerText = data.age ? `Вік: ${data.age}` : "";
  tokens.innerText = data.tokens;
}

async function loadShop() {
  const { data } = await supabase
    .from("shop_items")
    .select("*")
    .eq("is_active", true);

  shop.innerHTML = "";
  data.forEach(item => {
    shop.innerHTML += `
      <div class="item">
        <img src="${item.image_link}" class="shop-image">
        <h3>${item.title}</h3>
        <p>${item.price} токенів</p>
        <button onclick="buyItem('${item.id}')">Купити</button>
      </div>
    `;
  });
}

async function buyItem(itemId) {
  const { error } = await supabase.rpc("buy_item", { p_item_id: itemId });
  if (error) alert(error.message);
}

initUser();
</script>
</body>
</html>
